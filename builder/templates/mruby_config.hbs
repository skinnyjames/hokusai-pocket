{% if toolchain.android %}
MRuby::CrossBuild.new('android-arm64-v8a') do |conf|
  params = {
    :arch => 'arm64-v8a',
    :sdk_version => 33,
    :toolchain => :clang
  }
  toolchain :android, params

  {% for gem in gems %}
    conf.gem :{{ gem.from }} => '{{ gem.path }}'
  {% endfor %}

  conf.gembox 'default'
end
{% elif toolchain.web %}
MRuby::CrossBuild.new('emscripten') do |conf|
  conf.toolchain :emscripten

  {% for gem in gems %}
    conf.gem :{{ gem.from }} => '{{ gem.path }}'
  {% endfor %}

  conf.gem :github => "iij/mruby-regexp-pcre"
  conf.gembox 'default'
end
{% elif toolchain.mingw %}
MRuby::CrossBuild.new("cross-mingw") do |conf|
  conf.toolchain :gcc
  conf.host_target = "x86_64-w64-mingw32"  # required for `for_windows?` used by `mruby-socket` gem
  conf.cc.command = "#{conf.host_target}-gcc-posix"
  conf.linker.command = conf.cc.command
  conf.archiver.command = "#{conf.host_target}-gcc-ar"
  conf.exts.executable = ".exe"

  {% for gem in gems %}
    conf.gem :{{ gem.from }} => '{{ gem.path }}'
  {% endfor %}

  conf.gembox "default"
end
{% elif toolchain.nintendo_switch %}
MRuby::CrossBuild.new('nintendo_switch_32bit') do |conf|
  conf.toolchain :clang
  NINTENDO_SDK_PATH = ENV['NINTENDO_SDK_ROOT']

  include_paths = [
    "#{NINTENDO_SDK_PATH}/Include",
    "#{NINTENDO_SDK_PATH}/Common/Configs/Targets/NX-NXFP2-a32/Include"
  ]

  conf.cc do |cc|
    cc.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/bin/nx-clang++"
    cc.include_paths += include_paths
    cc.flags += ['-fpic -fno-short-enums -ffunction-sections -fdata-sections -fno-common -fno-strict-aliasing -fomit-frame-pointer -fno-vectorize -funsigned-char -O2 -g -mno-implicit-float']
    cc.defines += 'NN_SDK_BUILD_RELEASE'
  end

  conf.cxx do |cxx|
    cxx.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/bin/nx-clang++"
    cxx.include_paths += include_paths
    cxx.flags += ['-fpic -fno-short-enums -ffunction-sections -fdata-sections -fno-common -fno-strict-aliasing -fomit-frame-pointer -fno-vectorize -funsigned-char -O2 -g -mno-implicit-float']
    cxx.defines += 'NN_SDK_BUILD_RELEASE'
  end

  conf.archiver do |archiver|
    archiver.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/nx/armv7l/bin/llvm-ar"
  end

  conf.linker do |linker|
    linker.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/nx/armv7l/bin/clang++"
    linker.libraries = []
  end

  {% for gem in gems %}
    conf.gem :{{ gem.from }} => '{{ gem.path }}'
  {% endfor %}
  # Add your mrbgems
end

MRuby::CrossBuild.new('nintendo_switch_64bit') do |conf|
  conf.toolchain :clang
  NINTENDO_SDK_PATH = ENV['NINTENDO_SDK_ROOT']

  include_paths = [
    "#{NINTENDO_SDK_PATH}/Include",
    "#{NINTENDO_SDK_PATH}/Common/Configs/Targets/NX-NXFP2-a64/Include"
  ]

  conf.cc do |cc|
    cc.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/bin/nx-clang++"
    cc.include_paths += include_paths
    cc.flags += ['-fpic -fno-short-enums -ffunction-sections -fdata-sections -fno-common -fno-strict-aliasing -fomit-frame-pointer -fno-vectorize -funsigned-char -O2 -g -mno-implicit-float']
    cc.flags << '--target=aarch64-nintendo-nx-elf'
    cc.defines += 'NN_SDK_BUILD_RELEASE'
  end

  conf.cxx do |cxx|
    cxx.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/bin/nx-clang++"
    cxx.include_paths += include_paths
    cxx.flags += ['-fpic -fno-short-enums -ffunction-sections -fdata-sections -fno-common -fno-strict-aliasing -fomit-frame-pointer -fno-vectorize -funsigned-char -O2 -g -mno-implicit-float']
    cxx.flags << '--target=aarch64-nintendo-nx-elf'
    cxx.defines += 'NN_SDK_BUILD_RELEASE'
  end

  conf.archiver do |archiver|
    archiver.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/nx/aarch64/bin/llvm-ar"
  end

  conf.linker do |linker|
    linker.command = "#{NINTENDO_SDK_PATH}/Compilers/NX/nx/aarch64/bin/clang++"
    linker.libraries = []
  end
  
  {% for gem in gems %}
    conf.gem :{{ gem.from }} => '{{ gem.path }}'
  {% endfor %}
end
{% else %}
MRuby::Build.new do |conf|
  # load specific toolchain settings
  conf.toolchain :gcc

  conf.gem github: 'mattn/mruby-onig-regexp'
  # for testing
  {% for gem in gems %}
    {% if gem.path %}
      conf.gem :{{ gem.from }} => '{{ gem.path }}'
    {% else %}
      conf.gem '{{ gem.from }}'
    {% endif %}
  {% endfor %}

  # include the GEM box
  conf.gembox 'default'
  conf.enable_bintest
  conf.enable_test
end
{% endif %}
